{% extends 'base.html' %}
{% load static %}
{% block cssblock %}
<link href="{% static 'img/favicon.ico' %}" rel="icon">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
<link href="{% static 'lib/animate/animate.min.css' %}" rel="stylesheet">
<link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css' %}" rel="stylesheet">
<link href="{% static 'css/style.css' %}" rel="stylesheet">
    <style>
        
        /* Tùy chỉnh nhỏ cho tab */
        .profile-nav .nav-link {
            font-weight: 500;
        }
        .profile-nav .nav-link.active {
            color: #FFD333; /* Màu vàng của template */
            border-bottom: 2px solid #FFD333;
        }
        
        /* CSS cho thông báo lỗi của form */
        .form-error-list {
            list-style-type: none;
            padding: 0;
            color: #dc3545; /* Màu đỏ (danger) */
            font-size: 0.875em;
        }
    </style>
{% endblock %}


{% block content %}
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="{% url 'index' %}">Home</a>
                    <span class="breadcrumb-item active">Trang Cá Nhân</span>
                </nav>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-lg-3 mb-4">
                <div class="bg-light p-30">
                    <h5 class="text-uppercase mb-4">Quản lý tài khoản</h5>
                    <div class="nav flex-column nav-pills profile-nav" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <a class="nav-link {% if active_tab == 'profile' %}active{% endif %}" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile" role="tab" aria-controls="v-pills-profile" aria-selected="{% if active_tab == 'profile' %}true{% else %}false{% endif %}">Thông tin cá nhân</a>
                        <a class="nav-link" id="v-pills-orders-tab" data-toggle="pill" href="#v-pills-orders" role="tab" aria-controls="v-pills-orders" aria-selected="false">Lịch sử đơn hàng</a>
                        <a class="nav-link {% if active_tab == 'password' %}active{% endif %}" id="v-pills-password-tab" data-toggle="pill" href="#v-pills-password" role="tab" aria-controls="v-pills-password" aria-selected="{% if active_tab == 'password' %}true{% else %}false{% endif %}">Đổi mật khẩu</a>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="tab-content" id="v-pills-tabContent">
                    
                    <div class="tab-pane fade {% if active_tab == 'profile' %}show active{% endif %}" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">
                        <div class="bg-light p-30">
                            <h4 class="mb-4 text-uppercase">Thông tin cá nhân</h4>
                            
                            <form method="POST" action="{% url 'profile' %}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_profile">
                                
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label>Tên đăng nhập</label>
                                        <input class="form-control" type="text" value="{{ user.username }}" readonly>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label>Email</label>
                                        <input class="form-control" type="email" value="{{ user.email }}" readonly>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Họ và Tên</label>
                                    <input class="form-control" type="text" name="ho_ten" value="{{ user.ho_ten|default_if_none:'' }}">
                                </div>
                                <div class="form-group">
                                    <label>Số điện thoại</label>
                                    <input class="form-control" type="text" name="so_dien_thoai" value="{{ user.so_dien_thoai|default_if_none:'' }}">
                                </div>
                                <div class="form-group">
                                    <label>Địa chỉ</label>
                                    <input class="form-control" type="text" name="dia_chi" value="{{ user.dia_chi|default_if_none:'' }}">
                                </div>
                                <button type="submit" class="btn btn-primary">Cập nhật thông tin</button>
                            </form>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="v-pills-orders" role="tabpanel" aria-labelledby="v-pills-orders-tab">
                        <div class="bg-light p-30">
                            <h4 class="mb-4 text-uppercase">Lịch sử đơn hàng</h4>
                            <div class="table-responsive">
                                <table class="table table-light table-borderless table-hover text-center mb-0">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Mã ĐH</th>
                                            <th>Ngày đặt</th>
                                            <th>Tổng tiền</th>
                                            <th>Trạng thái</th>
                                            <th>Chi tiết</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody class="align-middle">
                                        {% for order in orders %}
                                        <tr>
                                            <td class="align-middle">#{{ order.id }}</td>
                                            <td class="align-middle">{{ order.ngay_dat|date:"d/m/Y H:i" }}</td>
                                            <td class="align-middle">{{ order.tong_tien|floatformat:0 }} VNĐ</td>
                                            <td class="align-middle">
                                                {% if order.trang_thai_don_hang == 'da_huy' %}
                                                    <span class="text-danger">{{ order.get_trang_thai_don_hang_display }}</span>
                                                {% elif order.trang_thai_don_hang == 'da_giao' %}
                                                    <span class="text-success">{{ order.get_trang_thai_don_hang_display }}</span>
                                                {% else %}
                                                    <span class="text-warning">{{ order.get_trang_thai_don_hang_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <a href="{% url 'order_detail' order.id %}" class="btn btn-sm btn-primary">Xem</a>
                                            </td>
                                            <td class="align-middle">
                                                {% if order.trang_thai_don_hang == 'cho_xu_ly' %}
                                                <form method="POST" action="{% url 'cancel_order' order.id %}" onsubmit="return confirm('Bạn có chắc chắn muốn hủy đơn hàng #{[ order.id ]} không?');">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-danger">Hủy</button>
                                                </form>
                                                {% else %}
                                                    <span>---</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6">Bạn chưa có đơn hàng nào.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade {% if active_tab == 'password' %}show active{% endif %}" id="v-pills-password" role="tabpanel" aria-labelledby="v-pills-password-tab">
                        <div class="bg-light p-30">
                            <h4 class="mb-4 text-uppercase">Đổi mật khẩu</h4>
                            
                            {% if password_form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in password_form.non_field_errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <form method="POST" action="{% url 'profile' %}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="change_password">
                                
                                <div class="form-group">
                                    <label for="{{ password_form.old_password.id_for_label }}">{{ password_form.old_password.label }}</label>
                                    <input type="password" name="old_password" class="form-control" required id="{{ password_form.old_password.id_for_label }}">
                                    {% if password_form.old_password.errors %}
                                        <div class="form-error-list">
                                        {% for error in password_form.old_password.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ password_form.new_password1.id_for_label }}">{{ password_form.new_password1.label }}</label>
                                    <input type="password" name="new_password1" class="form-control" required id="{{ password_form.new_password1.id_for_label }}">
                                    {% if password_form.new_password1.errors %}
                                        <div class="form-error-list">
                                        {% for error in password_form.new_password1.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ password_form.new_password2.id_for_label }}">{{ password_form.new_password2.label }}</label>
                                    <input type="password" name="new_password2" class="form-control" required id="{{ password_form.new_password2.id_for_label }}">
                                    {% if password_form.new_password2.errors %}
                                        <div class="form-error-list">
                                        {% for error in password_form.new_password2.errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Đổi mật khẩu</button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    {% endblock %}


{% block jsblock %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'lib/easing/easing.min.js' %}"></script>
<script src="{% static 'lib/owlcarousel/owl.carousel.min.js' %}"></script>
<script src="{% static 'mail/jqBootstrapValidation.min.js' %}"></script>
<script src="{% static 'mail/contact.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>

    {% endblock %}